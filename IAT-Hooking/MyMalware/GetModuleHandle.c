#include "GetModuleHandle.h"
#include "Utilities.h"

const char* DEFUALT_EXT = ".DLL";
HMODULE GetModuleHandleReplacement(IN LPCSTR szModuleName) {


#ifdef _WIN64
	PPEB				pPeb = (PEB*)(__readgsqword(0x60));
#elif _WIN32
	PPEB				pPeb = (PEB*)(__readgsqword(0x30));
#endif


	if (szModuleName == NULL) {
		return pPeb->ImageBaseAddress;
	}

	LPCSTR ext = strchr(szModuleName, '.');

	if (!ext) {

		SIZE_T len = strlen(szModuleName);
		SIZE_T extLen = strlen(DEFUALT_EXT);
		SIZE_T newLen = extLen + len + 1;
		LPCSTR temp = calloc(newLen, sizeof(char));

		if (temp == NULL) {
			printf("calloc failed");
			return NULL;
		}

		errno_t err = strncpy_s(temp, newLen, szModuleName, len);
		if (err) {
			printf("strncpy_s failed");
			return NULL;
		}
		err = strncat_s(temp, newLen, DEFUALT_EXT, extLen);
		if (err) {
			printf("strncat_s failed");
			return NULL;
		}
		szModuleName = temp;
	}

	PPEB_LDR_DATA			pLdr = (PPEB_LDR_DATA)pPeb->Ldr;
	//getting the first elemnt in the linked list (contian info about the first moduel)
	PTRUNCATED_LDR_DATA_TABLE_ENTRY pDte = (PTRUNCATED_LDR_DATA_TABLE_ENTRY)pLdr->InMemoryOrderModuleList.Flink;

	HMODULE hModule = NULL;


	while (pDte)
	{
		if (pDte->BaseDllName.Length != NULL) {

			if (IsWStrEqualCStr(pDte->BaseDllName.Buffer, szModuleName)) {
				wprintf(L"[+] Found Dll \"%s\" \n", pDte->BaseDllName.Buffer);
				hModule = pDte->DllBase;
				break;
			}
		}
		else {
			break;
		}

		pDte = pDte->InMemoryOrderLinks.Flink;

	}

	if (!ext) {
		free(szModuleName);
	}

	return hModule;
}
