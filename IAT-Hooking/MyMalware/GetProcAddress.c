#include "GetProcAddress.h"


FARPROC GetProcAddressReplacement(IN HMODULE hModule, IN LPCSTR lpApitName) {
	PBYTE pBase = (PBYTE)hModule;

	PIMAGE_DOS_HEADER pImgDosHdr = (PIMAGE_DOS_HEADER)pBase;
	if (pImgDosHdr->e_magic != IMAGE_DOS_SIGNATURE) {
		printf("not a exe\n");
		return NULL;
	}

	PIMAGE_NT_HEADERS pImgNtHdrs = (PIMAGE_NT_HEADERS)(pBase + pImgDosHdr->e_lfanew);

	if (pImgNtHdrs->Signature != IMAGE_NT_SIGNATURE) {
		printf("not a header\n");
		return NULL;
	}

	IMAGE_OPTIONAL_HEADER ImgOptHdr = pImgNtHdrs->OptionalHeader;
	IMAGE_DATA_DIRECTORY exportDataDir = ImgOptHdr.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT];
	PIMAGE_EXPORT_DIRECTORY pImgExportDir = (PIMAGE_EXPORT_DIRECTORY)(pBase + exportDataDir.VirtualAddress);

	PDWORD FunctionAddressArray = (PDWORD)(pBase + pImgExportDir->AddressOfFunctions);
	PVOID pFunctionAddress = NULL;

	if (lpApitName <= 0xFFFF) {
		WORD ordinal = (WORD)lpApitName & 0xFFFF;
		DWORD base = pImgExportDir->Base;

		if (ordinal < base || (ordinal >= base + pImgExportDir->NumberOfFunctions)) {
			return NULL;
		}
		pFunctionAddress = (PVOID)(pBase + FunctionAddressArray[ordinal - base]);

	}
	else {

		PDWORD FunctionNameArray = (PDWORD)(pBase + pImgExportDir->AddressOfNames);
		PWORD FunctionOrdinalArray = (PWORD)(pBase + pImgExportDir->AddressOfNameOrdinals);
		for (DWORD i = 0; i < pImgExportDir->NumberOfFunctions; i++) {
			CHAR* pFunctionName = (CHAR*)(pBase + FunctionNameArray[i]);
			if (strcmp(lpApitName, pFunctionName) == 0)
			{
				pFunctionAddress = (PVOID)(pBase + FunctionAddressArray[FunctionOrdinalArray[i]]); 
			}
		}
	}

	return pFunctionAddress;
}